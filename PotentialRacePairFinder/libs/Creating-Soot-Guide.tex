\documentclass[11pt]{article}
\usepackage{graphicx}
\usepackage{xspace}
\usepackage{listings}
\usepackage{dirtree}
\usepackage{hyperref}

\usepackage{adjustbox}
\usepackage{booktabs}
\usepackage{multirow}
\usepackage{geometry}

\geometry{a4paper, top=10mm, left=10mm, right=10mm}
\usepackage[table,xcdraw]{xcolor}
\newcommand{\kobj}{\textsc{$k$obj}\xspace}
\newcommand{\twoobj}{\textsc{$2$obj}\xspace}
\newcommand{\eagleobj}[1]{\textsc{E-#1obj}\xspace}
\newcommand{\zipperobj}[1]{\textsc{Z-#1obj}\xspace}
\newcommand{\toolobj}[1]{\textsc{T-#1obj}\xspace}
\newcommand{\threeobj}{\textsc{$3$obj}\xspace}
\newcommand{\zipper}{\textsc{zipper}\xspace}
\newcommand{\eagle}{\textsc{eagle}\xspace}
\newcommand{\tool}{\textsc{Turner}\xspace}
\definecolor{floralwhite}{rgb}{1.0, 0.98, 0.94}
\definecolor{gainsboro}{rgb}{0.86, 0.86, 0.86}
\definecolor{ghostwhite}{rgb}{0.97, 0.97, 1.0}
\definecolor{deepchampagne}{rgb}{0.98, 0.84, 0.65}
\definecolor{darkgray}{rgb}{0.66, 0.66, 0.66}
\definecolor{cornsilk}{rgb}{1.0, 0.97, 0.86}
\definecolor{antiquewhite}{rgb}{0.98, 0.92, 0.84}


\title{Integrating Soot into QiLin}
\author{Dongjie He}
\begin{document}
	\maketitle

QiLin is a pointer analysis framework built on top of Soot (with minor modification).
This guide introduces how to build a modified version of Soot that can be successfully 
integrated into QiLin. 

We use the latest version, i.e., \texttt{4.2.1}, for illustrating.

1. \textbf{Download Source}

The latest version of Soot can be downloaded from \url{https://github.com/soot-oss/soot/archive/4.2.1.tar.gz}.

\begin{lstlisting}[language=bash, backgroundcolor = \color{lightgray},]
$ wget https://github.com/soot-oss/soot/archive/4.2.1.tar.gz
$ tar xvf 4.2.1.tar.gz
$ cd soot-4.2.1
\end{lstlisting}

2. \textbf{Modify Soot}

Qilin implements a new context-insensitive pointer analysis which is also named Spark. We reuse many data structures from the original Spark in Soot. To avoid the name clash, we decide to remove the original Spark along with the projects that depend on it. Specifically, we have removed the following two directories:
\begin{lstlisting}[language=bash, backgroundcolor = \color{lightgray},]
$ rm -rf src/main/java/soot/jimple/spark/
$ rm -rf src/main/java/soot/jimple/toolkits/thread/
\end{lstlisting}
 

We have also removed the following 8 files:
\begin{lstlisting}[language=bash, backgroundcolor = \color{lightgray},]
$ rm src/main/java/soot/jimple/toolkits/callgraph/CallGraphBuilder.java
$ rm src/main/java/soot/jimple/toolkits/callgraph/OnFlyCallGraphBuilder.java
$ rm src/main/java/soot/jimple/toolkits/callgraph/CHATransformer.java
$ rm src/main/java/soot/jimple/toolkits/pointer/CodeBlockRWSet.java
$ rm src/main/java/soot/jimple/toolkits/pointer/InstanceKey.java
$ rm src/main/java/soot/xml/TagCollector.java
$ rm src/main/java/soot/XMLAttributesPrinter.java
$ rm src/main/java/soot/dava/toolkits/base/misc/ThrowFinder.java
\end{lstlisting}

These files depends on Spark pointer analysis. We will add these file back in the future if we require them.


Now, let us remove codes related to \texttt{spark} and \texttt{thread} in the following five files.
\begin{itemize}
	\item  \texttt{src/main/generated/singletons/soot/Singletons.java} 
	\item \texttt{src/main/java/soot/PackManager.java} 
	\item \texttt{src/main/java/soot/G.java}
	\item In  \texttt{src/main/java/soot/Scene.java}, we replace \texttt{SparkField} with \texttt{SootField} and then remove all  relevant code that may cause compile errors
	\item We modify \texttt{src/main/java/soot/SootField.java} to disable the class implement \texttt{SparkField} interface.
\end{itemize}
These codes will cause compile errors since they have references to files that we have already removed above.

Now, the code could be compile successfully with the following command:
\begin{lstlisting}[language=bash, backgroundcolor = \color{lightgray},]
$ mvn clean compile assembly:single
\end{lstlisting}

At last, let us append a few lines of code to \texttt{src/main/java/soot/Scene.java} to support QiLin.

(1). We add \texttt{addBasicClass("java.io.UnixFileSystem");} into method \texttt{private void addSootBasicClasses()} to support a native reflection in QiLin. 

(2). We add the following lines to method \texttt{protected void addReflectionTraceClasses()} to support the reflection log generated by Tamiflex.

\begin{lstlisting}[language=bash, frame=single, basicstyle=\tiny]
} else if (kind.equals("Field.toString") || kind.equals("Method.toString") || kind.equals("Constructor.toString")) {
	classNames.add(signatureToClass(target));
} else if (kind.equals("Field.getName") || kind.equals("Field.getDeclaringClass")) {
	classNames.add(signatureToClass(target));
} else if (kind.equals("Class.getDeclaredField") || kind.equals("Class.getDeclaredMethod")) {
	classNames.add(signatureToClass(target));
} else if (kind.equals("Class.getDeclaredFields") || kind.equals("Class.getDeclaredMethods")) {
	if (!target.startsWith("[")) {
		classNames.add(target);
	}
} else if (kind.equals("Class.getFields") || kind.equals("Class.getMethods")) {
	classNames.add(target);
} else if (kind.equals("Class.getMethod") || kind.equals("Class.getField")) {
	classNames.add(signatureToClass(target));
} else if (kind.equals("Constructor.getModifiers") || kind.equals("Field.getModifiers")) {
	classNames.add(signatureToClass(target));
} else if (kind.equals("Array.newInstance")) {
	// do nothing
} else if (kind.equals("Method.getModifiers") || kind.equals("Method.getName") || kind.equals("Method.toGenericString")) {
	classNames.add(signatureToClass(target));
} else if (kind.equals("Method.getDeclaringClass")) {
	classNames.add(signatureToClass(target));
} 
\end{lstlisting}


We should also fix a bug in soot in resolving non-special call target.
In method \texttt{getSignaturePolymorphicMethod} of \texttt{FastHierarchy}, we need to append these lines:
\begin{lstlisting}[language=bash, frame=single,]
String subsig = SootMethod.getSubSignature(name, parameterTypes, returnType);
candidate = concreteType.getMethodUnsafe(subsig);
if (candidate != null) {
	return candidate;
}
\end{lstlisting}


3. \textbf{Ready to go}

Now, it's ready to compile soot and integrate it into QiLin.

Again, let us use the following line to compile Soot:
\begin{lstlisting}[language=bash, backgroundcolor = \color{lightgray},]
$ mvn clean compile source:jar assembly:single
\end{lstlisting}
And then, let us move Soot to \texttt{qilin/libs/} and our job is done.
\begin{lstlisting}[language=bash, backgroundcolor = \color{lightgray},]
$ mv target/sootclasses-trunk-jar-with-dependencies.jar qilin/libs/
$ mv target/sootclasses-trunk-sources.jar qilin/libs/
\end{lstlisting}


\end{document}